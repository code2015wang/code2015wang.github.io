<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="淡泊明志 宁静致远">
<meta property="og:type" content="website">
<meta property="og:title" content="hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="hexo">
<meta property="og:description" content="淡泊明志 宁静致远">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hexo">
<meta name="twitter:description" content="淡泊明志 宁静致远">
  
    <link rel="alternate" href="/atom.xml" title="hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">hexo</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">读书取正 读易取变 读骚取幽 读庄取达 读汉取坚 最有味卷中岁月</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-docker/docker" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/12/08/docker/docker/" class="article-date">
  <time datetime="2018-12-08T14:44:24.231Z" itemprop="datePublished">2018-12-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/12/08/docker/docker/">容器即服务之docker</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="容器即服务之docker"><a href="#容器即服务之docker" class="headerlink" title="容器即服务之docker"></a>容器即服务之docker</h1><h2 id="docker容器及服务的发展"><a href="#docker容器及服务的发展" class="headerlink" title="docker容器及服务的发展"></a>docker容器及服务的发展</h2><p>docker的单机模式到集群模式，从经典Swarm 、独立的Swarm Kit 项目到内置docker的Swarm Mode，docker对集群的支持越来越给力。在构建集群、管理节点、管理服务以及编排部署多容器构成的复杂服务方法，docker都有成熟的方案。基于Swarm Mode的容器集群是当下各种主流容器集群中最容易使用和构建的一款，是理解和实践这种集群之上管理服务的思维模式很好的起点。</p>
<h2 id="经典Swarm、SwarmKit和Swarm-Mode"><a href="#经典Swarm、SwarmKit和Swarm-Mode" class="headerlink" title="经典Swarm、SwarmKit和Swarm Mode"></a>经典Swarm、SwarmKit和Swarm Mode</h2><p>早在2014年Docker公司就着手设计了一套容器集群的组合方案：Machine、Swarm和compose.在这个方案中，Machine是一款用于各种主流虚拟机和云平台快速构建Docker运行环境的工具，它支持在创建的节点上自动部署swarm.当时的swarm是一款整合跨节点网络集群式容器运维管理服务，它利用docker守护进程的API，将多节点资源进行汇总，并提供完全兼容docker 运行的API，既可以像操作单个节点的容器服务一样操作整个容器集群。Compose用于容器编排，管理服务，实现高可用和多副本。</p>
<p>在2016年，docker公司低调的开始了SwarmKit项目，该项目的作用与Swarm相似。但因为意识到docker APi与服务模型和集群化场景不相符，SwarmKit开始重新开发一套API和模型体系，并且采用了独立的客户端命令行：swarmctl。</p>
<p>真正让SwarmKit项目为众所周知的是在docker 1.12版本中开始创建一键创建容器集群的新命令：docker swarm。这个后来被称为Swarm mode正是Swarm Kit的功劳。Docker Mode并非是一种特定的运行模式，而是Docker中一组与集群相关功能的统称，docker通过不同的命令允许使用者同时以“当前节点”和“整个集群”两种视角来操作容器。下面重点介绍Docker Swarm Mode。</p>
<h2 id="Docker-Swarm-Mode"><a href="#Docker-Swarm-Mode" class="headerlink" title="Docker Swarm  Mode"></a>Docker Swarm  Mode</h2><p>Swarm Mode是指docker 整合了Swarm kit 项目后增加的部分，包括对集群的管理、节点的管理、服务的管理和编排，以及其他辅助功能。</p>
<h3 id="集群的创建和销毁"><a href="#集群的创建和销毁" class="headerlink" title="集群的创建和销毁"></a>集群的创建和销毁</h3><p>通过docker 的 docker swarm 命令集可以创建和管理集群，它的参数比Swarm kit中更简单。在大多数情况下，可以直接使用不带任何参数的docker swarm init 命令就可以创建一个新的集群。执行创建集群命令的节点会自动成为该集群的第一个Manager节点，同时打印出一个用来添加爱更多节点的命令，该命令的模式是 docker swarm join-token <token> <manager-ip> ,其中toiken是用来区分加入者的角色。要是忘记了可以使用docker swarm join-token 命令找回（加上manage或者worek 表示要找回的token种类）。值得注意的是，添加work和manage的token是不一样的，token不仅可以保证集群中不会随意混入无关节点的凭证，也是区分节点加入时不同角色的依据。</manager-ip></token></p>
<p>如果token失效怎么办？docker提供了一种token轮换机制，即在查看token的命令中，加上–rotate参数。每次执行这个命令会改变相应的角色加入集群的态哦肯，并使得过去的token失效，这只会影响加入的节点，已经集群中的节点不受影响。</p>
<h3 id="节点管理"><a href="#节点管理" class="headerlink" title="节点管理"></a>节点管理</h3><p>在docker Swarm Mode中管理节点的命令是docker node。当集群创建完成后，使用docker node ls 命令可以看到各个节点的基本状态信息。docker node ps 可以查看指定节点运行的task信息。docker swarm中节点的角色是可以转变的，进行角色转变的命令是docker sawrm promote 和docker swarm demote。他们的参数是被转换的节点ID。需要指出的是，所有与集群节点、服务以及密文管理的操作必须在管理节点上进行，因此work节点是不能把自己提升为manager节点的。对于节点角色的转换实际是改变节点属性的特例，对于通用情况是，可以使用docker node update命令。</p>
<h3 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h3><p>在服务管理中是有task和service概念的，其中task是对底层单元的抽象，在当前docker Mode中，一个task实际上就是一个容器，他是swarm Mode中最小调度单元，用于运行一个service容器的副本。在docker swarm中没有专门管理task的命令，不过通常使用docker container命令来操作容器。service是用来部署的单元，每个service中可以包含一个或多个相同容器的副本，分布在不同集群的节点上，根据负载均衡需要进行扩缩。Stack是docker Mode中与服务编排相关的概念，它将多个不同的固定service关联在一起，进行整体部署和升级，对外体现为多种容器组合而成的复杂系统。</p>
<p>创建服务的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --detach --name web  --publish 8080:80 --replicas=3 nginx:1.11.1-alpine</span><br></pre></td></tr></table></figure>
<p>此外docker Swarm Mode还额外做了一些配置工作，首先将服务注册到集群内的DNS ，这样与容器处在同一网络的的其他容器就可以直接通过服务名来访问此服务，这里的网络是指由docker network 命令管理的容器网络。</p>
<p>在服务管理中，还有一件必须要考虑的事情，就是 服务的版本升级。在容器化的体系中，升级一个服务实际就是替换镜像。然而镜像的替换意味着重启容器，但在实际生产环境中，一个服务的容器并不是想停就能停的。不过由于docker Swarm Mode在容器创建服务都提供了容器副本相关的负载均衡器，因此如果服务本身是无状态的，就可以使用一种被称为滚动升级的方式，完成不离线的版本变更。服务的滚动升级是指将集群中处于同一个负载均衡器背后的副本实例逐步的替换，并动态更新负载的流量，以确保在整个升级过程中对外服务功能不停止。如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service update web --image nginx-1.11.5-apline --update-parrallelism 1 --update-delay 3s</span><br></pre></td></tr></table></figure>
<p>在升级过程中，可以从另外一个控制台窗口观察服务的task容器变化过程，每个三秒替换一个容器，直到所有的版本升级完成。</p>
<p>严格说来，Swarm mode中的滚动升级并不是很完整，因为只能做正向替换，如果升级错误，只能通过以低版本镜像为目标再一次滚动升级来完成降级。</p>
<h3 id="服务编排"><a href="#服务编排" class="headerlink" title="服务编排"></a>服务编排</h3><p>服务编排是指安装服务之间的关联进行统一管理，以快速构建基于容器的复杂应用的一种方式。Compose一直是docker的服务编排工具，它通过要一个YAML文件来描述各个容器之间的关联。然后提供一组命令以整体视角操作所有容器。</p>
<h3 id="应用栈管理"><a href="#应用栈管理" class="headerlink" title="应用栈管理"></a>应用栈管理</h3><p>描述服务编排的docker compose 同样可以被用于在集群中部署服务和管理服务之间的关联，不过集群编排部署和单机的情况有点差异，主要体现在两者支持功能的差异，比如，在集群部署的服务通常会使用overlay类型的网络，不支持–net=host模式的容器，不支持挂载本地设备，但swarm集群模式下增加了对外置配置和密文的支持。在swarm 集群中，将通过编排方式部署到集群中的一组服务称为应用栈（stack）。通过docker命令行工具docker stack 下的子命令可以对集群中的应用栈进行管理。如集群部署文件示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">version:"3.3"</span><br><span class="line">service:</span><br><span class="line">    redis: </span><br><span class="line">        images:redis:3.2.5-qlpine</span><br><span class="line">        networks:</span><br><span class="line">            -demo-net</span><br><span class="line">    app:</span><br><span class="line">         images:flin/page-hit-counter:v1</span><br><span class="line">         ports:</span><br><span class="line">             - 5000:5000</span><br><span class="line">         networks:</span><br><span class="line">             - demo-net</span><br><span class="line">         deploy:</span><br><span class="line">             replacas: 2</span><br><span class="line">    networks:</span><br><span class="line">         demo-net:</span><br><span class="line">             driverer:overlay</span><br><span class="line">             external:false</span><br></pre></td></tr></table></figure>
<p>使用docker swarm 命令创建集群并添加几个节点，然后使用docker stack deploy 命令部署创建集群到集群的应用栈。</p>
<p>一些常用命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker stack  deplloy -c docker-compose.yaml app</span><br><span class="line">dcoker stack ls</span><br><span class="line">docker stack services</span><br><span class="line">docker stack rm</span><br></pre></td></tr></table></figure>
<h3 id="外置配置和密文管理"><a href="#外置配置和密文管理" class="headerlink" title="外置配置和密文管理"></a>外置配置和密文管理</h3><p>在许多企业中，一些与环境相关的信息往往由专门的配置部门管理，开发团队不关心线上使用数据库地址、密码以及其他与程序逻辑无关的事。Docker Swarm的外置配置和密文就是为了支持这种职责分离的场景而引入的。</p>
<p>与配置相关的操作定义在docker config命令下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker config create </span><br><span class="line">docker config ls</span><br><span class="line">docker inspect</span><br><span class="line">docker config rm</span><br></pre></td></tr></table></figure>
<p>运用示例：</p>
<p>首先创建一个config外置配置对象：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF | docker config create demo-config -</span><br><span class="line">&#123;</span><br><span class="line">    "name":"demo"</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>创建服务，使用–config 参数将预先创建到集群的外置配置挂在到容器中，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --detach --replicas 1 --name nginx --config demo-config agin：apline</span><br></pre></td></tr></table></figure>
<p>外置配置是默认挂在到容器的根目录中。不过也可以指定挂载路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --detach --replicas 1 --name nginx --config src=demo-config，target=“/etc/demo-config” nginx:alpine</span><br></pre></td></tr></table></figure>
<p>与外置配置的相比，密文的主要区别是，它的内容在容器中存储和在容器传输都是加密形式的，只在目的节点被解密加载到内存中，然后从内存中映射到容器内。而外置配置则是以普通磁盘文件的形式挂在到容器里。由于存在加和解密的开销，单个密文被限制为500k。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker secret create </span><br><span class="line">docker secret ls</span><br><span class="line">docker secret inspect</span><br><span class="line">docker decret rm</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "这是miw" | docker secret create demo-passwd</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --detach --replicas 1 --name nginx --secret demo-passwd nginx：apline</span><br></pre></td></tr></table></figure>
<h3 id="Swarm-Mode-的图形界面"><a href="#Swarm-Mode-的图形界面" class="headerlink" title="Swarm Mode 的图形界面"></a>Swarm Mode 的图形界面</h3><p>在社区项目中，最值得一提的是Portainer ，这个项目从docker诞生不久开始启动，一路跟随docker 踏过单机时代和经典Swarm时代，现在完美支持新的Swarm Mode集群，并保持良好的活跃度和发布频率，是Docker Swarm集群可视化中值得一试的开源方案。</p>
<p>Portainer的前端界面采用Angular框架，代码结构和用户体验十分优雅，由于Portainer采用本地文件而非数据库文件的方式存储服务状态，它在部署时没有额外的依赖，只需要在集群的Mangaer节点启动partainer容器即可使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name poartainer --restart always p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v /opt/portainer:/data poatainer/poatainer</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/12/08/docker/docker/" data-id="cjpfkhtrz0006u9t2jsal3v2y" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ML/caffe_tensorflow_mxnet_visualization" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/21/ML/caffe_tensorflow_mxnet_visualization/" class="article-date">
  <time datetime="2018-11-21T14:14:30.363Z" itemprop="datePublished">2018-11-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/21/ML/caffe_tensorflow_mxnet_visualization/" data-id="cjpfkhtrn0001u9t21rod9rjv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-python/ansible" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/18/python/ansible/" class="article-date">
  <time datetime="2018-11-18T14:32:08.400Z" itemprop="datePublished">2018-11-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/18/python/ansible/" data-id="cjpfkhtrs0003u9t299gid3xd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-python/netdata" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/17/python/netdata/" class="article-date">
  <time datetime="2018-11-17T14:56:41.041Z" itemprop="datePublished">2018-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/17/python/netdata/" data-id="cjpfkhtrw0005u9t2vko8cus6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-python/django-restfull" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/17/python/django-restfull/" class="article-date">
  <time datetime="2018-11-17T14:42:47.344Z" itemprop="datePublished">2018-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/17/python/django-restfull/" data-id="cjpfkhtru0004u9t2yfs04cfp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ML/deeplearning-info" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/17/ML/deeplearning-info/" class="article-date">
  <time datetime="2018-11-17T14:42:13.359Z" itemprop="datePublished">2018-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/17/ML/deeplearning-info/" data-id="cjpfkhtrp0002u9t2u2hxu2lo" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docker/docker_compose_swarm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/17/docker/docker_compose_swarm/" class="article-date">
  <time datetime="2018-11-17T14:39:02.308Z" itemprop="datePublished">2018-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/17/docker/docker_compose_swarm/">docker 三剑客</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="docker-三剑客"><a href="#docker-三剑客" class="headerlink" title="docker 三剑客"></a>docker 三剑客</h1><p>​    docker是开源的应用容器引擎，让开发者可以打包自己的应用到一个可移植的容器中，做到开发、测试、运行环境的一致。其核心是Cgroup、namespace技术及联合文件系统，在这些技术的基础上，容器是完全轻量、在一定程度上安全的虚拟机技术。一个完整的Docker由以下几部分组成：</p>
<ul>
<li>docker Client 客户端</li>
<li>Docker daemon 守护进程</li>
<li>Docker images 镜像</li>
<li>Docekr Container 容器</li>
</ul>
<p>由此可见，Dokcer采用C/S架构，Docker daemon做为服务端接受来自Client端的请求，并作出响应。</p>
<p>docker有一些典型的应用场景：</p>
<ol>
<li>应用打包与自动化部署</li>
<li>自动化测试与持续集成/部署</li>
<li>部署与扩展webapp、数据库和后台服务</li>
<li>创建轻量PASS环境</li>
</ol>
<p>下面我们来重点聊一聊有docker三剑客之称的docker machine、docker swarm和docker compose</p>
<p>Docker-Machine 用于在其他平台中快速安装Docker ，docker-Swarm可以让docker集群中高效运行。Docker-Compose属于应用层的工具，主要用于docker集群中快速部署。利用docker-compose ，用户可以指定那些容器运行那些任务，与此同时docker-compose也支持热部署。</p>
<h2 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker compose"></a>docker compose</h2><p>​      docker compose 是容器编排工具，说白就是在一台服务器上管理多个容器。在没有docker compose之前，我们管理应用的工作流应该是这样的：通过dockerfile生成多个镜像，手动创建多个镜像，管理多个镜像。为什么是多个镜像哪？因为容器之间有依赖关系。那能不能把所有容器集成为一个容器，可以是可以，但步推荐这么做，因为这个容器的初衷不符。那docker compose是怎么做的哪？首先docker cmpose 是个命令行工具，docker本身自带，与docker深度集成。其次，docker compose通过yml文件来定义容器之间的依赖关系，通过yml来管理一组容器。</p>
<p>​     docker yml有个默认的名字docker-compose.yml，其中三个重要的概念：</p>
<ul>
<li>SERVICE</li>
<li>NETWORK</li>
<li>VOLUMES</li>
</ul>
<p>我们想一下我们通常应用都由那几部分组成？拿常见的web应用来说：前端、后台、数据库，抽象起来那就是服务、网络和数据。同样的，在docker compose 的中service用于定义服务，network用来定义容器（也就是服务）之间如何通信，volume是定义容器（服务）的数据放在哪里。下面我们来看一个docker compose文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"2.3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  cvat_db:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">cvat_db</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">postgres:10.3-alpine</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      default:</span></span><br><span class="line"><span class="attr">        aliases:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">db</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      POSTGRES_USER:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">      POSTGRES_DB:</span> <span class="string">cvat</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - cvat_db:</span><span class="string">/var/lib/postgresql/data</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  cvat_redis:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">cvat_redis</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">redis:4.0.5-alpine</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="attr">      default:</span></span><br><span class="line"><span class="attr">        aliases:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">redis</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  cvat:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">cvat</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">cvat</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">    depends_on:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cvat_redis</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">cvat_db</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"8080:8080"</span></span><br><span class="line"><span class="attr">    build:</span></span><br><span class="line"><span class="attr">      context:</span> <span class="string">.</span></span><br><span class="line"><span class="attr">      args:</span></span><br><span class="line"><span class="attr">        http_proxy:</span></span><br><span class="line"><span class="attr">        https_proxy:</span></span><br><span class="line"><span class="attr">        no_proxy:</span></span><br><span class="line"><span class="attr">        TF_ANNOTATION:</span> <span class="string">"no"</span></span><br><span class="line"><span class="attr">        USER:</span> <span class="string">"django"</span></span><br><span class="line"><span class="attr">        DJANGO_CONFIGURATION:</span> <span class="string">"production"</span></span><br><span class="line"><span class="attr">        WITH_TESTS:</span> <span class="string">"no"</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      DJANGO_MODWSGI_EXTRA_ARGS:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - cvat_data:</span><span class="string">/home/django/data</span></span><br><span class="line"><span class="attr">      - cvat_keys:</span><span class="string">/home/django/keys</span></span><br><span class="line"><span class="attr">      - cvat_logs:</span><span class="string">/home/django/logs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  cvat_db:</span></span><br><span class="line"><span class="attr">  cvat_data:</span></span><br><span class="line"><span class="attr">  cvat_keys:</span></span><br><span class="line"><span class="attr">cvat_logs:</span></span><br></pre></td></tr></table></figure>
<p>这个docker compose文件是cavt项目的docker compose文件，项目地址为<a href="https://github.com/code2015wang/cvat.git，欢迎大家fork，一起成长。" target="_blank" rel="noopener">https://github.com/code2015wang/cvat.git，欢迎大家fork，一起成长。</a></p>
<p>通过这个文件，我们可以看到在docker compose中一个service被分为三个部分：镜像、网络和挂载卷。</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d # 以后台的方式启动服务</span><br><span class="line">docker-compose ps # 查看启动服务</span><br><span class="line">docker-compsoe start # 启动服务</span><br><span class="line">docker-compose kill # 杀掉容器</span><br><span class="line">docker-compose stop</span><br><span class="line">docker-compose scale # 水平扩展服务</span><br></pre></td></tr></table></figure>
<h2 id="docker-swam"><a href="#docker-swam" class="headerlink" title="docker swam"></a>docker swam</h2><p>​     docker swarm 是一个docker化的分布式应用程序的本地集群，就是容器调度工具，可以实现主机资源利用率和提供故障转移服务。具体的来说，Docker Swarm 允许用户创建主机资源池来运行docker守护进程，然后调度容器在资源池上运行，自动管理工作负载和维护集群状态。docker swarm是docker原生的，同时也是最简单的、最易学的、最节省资源的，比较适合中小型公司使用，docker swaem提供了一套高可用Docker集群管理方案，完全支持标准的docker API，方便管理调度集群Docker容器，合理充分利用集群主机资源。docker swarm是一个为IT运维团队提供集群和调度能力的编排工具。经测试：Swarm的可扩展性极限是在1000个节点上运行50000个部署容器，每个容器的启动时间是亚秒级，同时性能无减损。</p>
<h3 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h3><ol>
<li>节点</li>
</ol>
<p>docker swarm管理的集群中节点可以分为两种：管理节点和工作节点。管理节点用于管理swarm集群，docker swarm命令基本只能在管理节点执行（节点退出命令可以在工作节点执行）。docker swarm集群中可以有多个管理节点，但只能有一个leader。工作节点是执行任务得节点，管理节点将服务下发到任务节点，管理节点也默认为工作节点。</p>
<ol start="2">
<li>服务和任务</li>
</ol>
<p>任务是swarm集群能调度的最小单位，目前来说就是一个容器。服务则可以理解为多个任务的集合，服务定义任务的属性。服务有两种模式：</p>
<p>reolicated service：按照一定规则在各个工作节点上运行制定个数的任务。</p>
<p>global service 每个工作节点运行一个任务</p>
<h3 id="swarm使用"><a href="#swarm使用" class="headerlink" title="swarm使用"></a>swarm使用</h3><ul>
<li>初始化集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm --init --advertise-addr 192.168.99.100</span><br></pre></td></tr></table></figure>
<p>命令运行成功后会生成一个token，这个token是工作节点加入集群的凭据。</p>
<p>工作节点加入集群：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm join --token ..... 192.168.99.100:2377</span><br></pre></td></tr></table></figure>
<ul>
<li>在master节点上创建服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --replicas 2 -d -p 8080：80 --name mynginx registry.docker-cn.com/library/nginx</span><br></pre></td></tr></table></figure>
<ul>
<li>查看服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker service ls</span><br><span class="line">docker service ps mynignx</span><br></pre></td></tr></table></figure>
<ul>
<li>进一步扩展服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service scale mynginx=3</span><br></pre></td></tr></table></figure>
<p>todo : docker swarm 调度深度学习任务</p>
<p>容器如何使用GPU：Nvidia-docker</p>
<p>集群之间如何根据GPU分配资源： Nvidia-docker device plugin</p>
<p>容器之间如何通信： overlay network or host network</p>
<p>多机任务周期管理</p>
<p>​    </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/17/docker/docker_compose_swarm/" data-id="cjpfkhts20007u9t28tuxj31a" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/11/17/hello-world/" class="article-date">
  <time datetime="2018-11-17T09:06:50.695Z" itemprop="datePublished">2018-11-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/11/17/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/11/17/hello-world/" data-id="cjpfkhtqe0000u9t2pnpb82s7" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/12/08/docker/docker/">容器即服务之docker</a>
          </li>
        
          <li>
            <a href="/2018/11/21/ML/caffe_tensorflow_mxnet_visualization/">(no title)</a>
          </li>
        
          <li>
            <a href="/2018/11/18/python/ansible/">(no title)</a>
          </li>
        
          <li>
            <a href="/2018/11/17/python/netdata/">(no title)</a>
          </li>
        
          <li>
            <a href="/2018/11/17/python/django-restfull/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 紫色联盟<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>